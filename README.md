# CW305 Shell

This repository provides a shell template for NewAE CW305 FPGA.
Vivado 2023.2 was used to verify the design.

## Overview

CW305 is an FPGA board of ChipWhisperer family, which is designed for side-channel analysis.
The board has a Xilinx Artix-7 FPGA and Atmel SAM3U microcontroller.
The microcontroller is responsible for data communication between the host PC and the FPGA, including programming the FPGA.
A dedicated bus between the FPGA and the microcontroller consists of 8 bits of data and 21 bits of address.
However, there is no handshake primitive in the bus and thus, the FPGA must respond to the microcontroller within a fixed cycle.
This shell template mitigates the issue by introducing ACK-based communication protocol.
This feature allows the FPGA design variable latency data access.
In addition, the shell template converts the read/write request from the host PC to AXI4-Lite protocol, which is widely used.
Such a common bus interface enables you to easily evaluate your cryptographic module or soft macro IP on the FPGA.

## Clock domain crossing
The shell template allows you to implement the cryptographic module with a different clock frequency from the microcontroller interface.
Xilinx AXI Interconnect IP is used to convert the clock domain regarding AXI bus.
The force trigger signal sent by the microcontroller is synchronized with the clock of the cryptographic module based on 2-phase handshake protocol by our interface module.

## Create a project from the template

First, clone this repository.
```bash
git clone https://github.com/hal-lab-u-tokyo/cw305-shell.git
cd cw305-shell
```

The following command will launch Vivado and create a project
```bash
vivado -source vivado/init-shell-project.tcl
```
For more details, see [doc/create_project.md](doc/create_project.md).

## ChipWhispere extension for communication with the shell
Our [ChipWhisperer extension](https://github.com/hal-lab-u-tokyo/chipwhisperer-enhanced-plugins) includes a driver to communicate with the shell based on ChipWhisperer API.
First, install the extension according to the instruction in the repository.

The following is an example code to instantiate the shell object.
```python
import chipwhisperer as cw
from cw_plugins.targets.CW305Shell import CW305Shell

# Connect to oscilloscope to capture power traces
scope = cw.scope()

# Connect to the CW305 board and configure the FPGA with the shell design
bsfile = "path/to/bitstream_file"
hwh_file = "path/to/hwh_file"
target = cw.target(scope, CW305Shell, bsfile=bsfile, hwh_file=hwh_file)

# Setup the target with default settings
target.setup()


# Example: LED control with high-level API
target.fpga_led_on(CW305Shell.LED_COLOR.BLUE)

# Example: Same operation with low-level API
led_addr = target.memmap.axi_gpio.base + 0x8
target.fpga_write(led_addr, 1)

```

`CW305Shell.memmap` provides the address map of the shell design, which is decoded from the HWH file.
The HWH file is generated by the Vivado project in `<vivado_proj>/<proj_name>.gen/sources_1/bd/main/hw_handoff/`.

## Misc.
This repository includes a base constraint file for the CW305 board.
It specifies all the IO pins of the FPGA and on-board peripherals according to the schematic.
However, pins which are not used in the shell design are not tested.

## License

This repository is licensed under MIT License, see [LICENSE](LICENSE) for more information.

## Similar projects
* [SAKURA-X shell](https://github.com/hal-lab-u-tokyo/sakura-x-shell/) - A shell template for SAKURA-X FPGA
